{% extends "base.html" %}

{% block title %}国际太阳能新闻 - 多来源翻译{% endblock %}

{% block nav_extra %}
    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="{{ url_for('news_search') }}">
            <i class="fas fa-newspaper me-1"></i>国内新闻
        </a>
        <a class="btn btn-outline-primary" href="{{ url_for('index') }}">
            <i class="fas fa-home me-1"></i>返回主页
        </a>
    </div>
{% endblock %}

{% block content %}
<!-- 头部区域 -->
<div class="header-section">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-3">国际太阳能新闻</h1>
        <p class="lead mb-4">多来源国际太阳能新闻 - PV Magazine、IRENA、IEA - 支持中英文翻译</p>
    </div>
</div>

<div class="container">
    <!-- 数据信息区域 -->
    <div id="data-info" class="mb-3">
        <!-- 数据信息将在这里显示 -->
    </div>

    <!-- 筛选区域 -->
    <div class="filter-card">
        <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label fw-bold">开始日期</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">结束日期</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">关键词</label>
                    <input type="text" class="form-control" id="keyword" placeholder="输入关键词...">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">来源筛选</label>
                    <select class="form-select" id="sourceFilter">
                        <option value="">全部来源</option>
                        <option value="PV Magazine">PV Magazine</option>
                        <option value="IRENA">IRENA</option>
                        <option value="IEA">IEA</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="translateToggle" checked>
                        <label class="form-check-label fw-bold" for="translateToggle">
                            <i class="fas fa-language me-1"></i>显示翻译
                        </label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100 mb-2" onclick="loadNews()">
                        <i class="fas fa-search me-2"></i>筛选新闻
                    </button>
                    <button class="btn btn-outline-primary w-100" id="refreshBtn" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="totalCount">0</div>
                <div class="stats-label">总新闻数</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number" id="filteredCount">0</div>
                <div class="stats-label">筛选结果</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number text-info" id="pvMagazineCount">0</div>
                <div class="stats-label">PV Magazine</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number text-warning" id="irenaCount">0</div>
                <div class="stats-label">IRENA</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number text-success" id="ieaCount">0</div>
                <div class="stats-label">IEA</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stats-card">
                <div class="stats-number text-success" id="translatedCount">0</div>
                <div class="stats-label">已翻译</div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3">正在加载多来源新闻数据...</p>
    </div>

    <!-- 新闻列表 -->
    <div id="newsList"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 设置默认日期（最近三个月）
    function setDefaultDates() {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 3);
        
        document.getElementById('startDate').valueAsDate = startDate;
        document.getElementById('endDate').valueAsDate = endDate;
    }
    
    // 加载数据统计信息
    async function loadDataInfo() {
        try {
            const response = await fetch('/get_translated_stats');
            const data = await response.json();
            
            if (data.success) {
                const infoDiv = document.getElementById('data-info');
                const sources = data.source_stats || {};
                
                infoDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="fas fa-database me-1"></i>数据来源:</strong> 
                                PV Magazine (${sources['PV Magazine'] || 0}) | 
                                IRENA (${sources['IRENA'] || 0}) | 
                                IEA (${sources['IEA'] || 0})
                                <span class="ms-3"><strong>数据总量:</strong> ${data.total_count} 条新闻</span>
                                <span class="ms-3"><strong>最后更新:</strong> ${data.last_update || '未知'}</span>
                            </div>
                            <div>
                                <span class="badge bg-success">
                                    <i class="fas fa-language me-1"></i>已翻译
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('data-info').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>${data.error || '无法获取数据信息'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('获取数据信息失败:', error);
            document.getElementById('data-info').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>无法获取数据统计信息
                </div>
            `;
        }
    }

    // 刷新数据
    async function refreshData() {
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn.innerHTML;

        try {
            // 显示刷新中状态
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>刷新中...';

            // 调用刷新API
            const response = await fetch('/refresh_translated_news');
            const result = await response.json();

            if (result.success) {
                // 刷新成功，重新加载数据信息和新闻列表
                await loadDataInfo();
                await loadNews();

                // 显示成功消息
                showMessage(result.message, 'success');
            } else {
                showMessage(result.error || '数据刷新失败', 'danger');
            }
        } catch (error) {
            console.error('刷新数据失败:', error);
            showMessage('刷新失败，请稍后重试', 'danger');
        } finally {
            // 恢复按钮状态
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalText;
        }
    }

    // 加载新闻数据
    async function loadNews() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const keyword = document.getElementById('keyword').value;
        const sourceFilter = document.getElementById('sourceFilter').value;
        const translate = document.getElementById('translateToggle').checked;
        
        // 显示加载动画
        document.getElementById('loading').style.display = 'block';
        document.getElementById('newsList').innerHTML = '';
        
        try {
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (keyword) params.append('keyword', keyword);
            if (sourceFilter) params.append('source', sourceFilter);
            
            const response = await fetch(`/get_translated_news?${params}`);
            const result = await response.json();
            
            if (result.success) {
                displayNews(result.data, translate);
                updateStats(result);
            } else {
                showMessage('加载失败: ' + result.error, 'error');
                document.getElementById('newsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h4 class="text-warning">数据加载失败</h4>
                        <p class="text-muted">${result.error || '未知错误'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载新闻数据失败:', error);
            showMessage('网络错误: ' + error.message, 'error');
            document.getElementById('newsList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-wifi fa-3x text-danger mb-3"></i>
                    <h4 class="text-danger">网络连接失败</h4>
                    <p class="text-muted">请检查网络连接后重试</p>
                </div>
            `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }
    
    // 显示新闻列表
    function displayNews(newsData, translateEnabled) {
        const newsList = document.getElementById('newsList');
        
        if (newsData.length === 0) {
            newsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">未找到相关新闻</h4>
                    <p class="text-muted">请尝试调整筛选条件</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let translatedCount = 0;
        
        newsData.forEach((news, index) => {
            const hasTranslation = news.title_translated && news.title_translated !== news.title_original;
            if (hasTranslation) translatedCount++;
            
            // 处理日期显示
            const newsDate = news.publish_date || news.date || '未知日期';
            const newsSummary = news.summary || '';
            const newsLink = news.link || '#';
            const source = news.source || 'Unknown';
            
            // 根据来源设置样式
            let sourceClass = 'secondary';
            let sourceColor = '#6c757d';
            if (source === 'PV Magazine') {
                sourceClass = 'info';
                sourceColor = '#17a2b8';
            } else if (source === 'IRENA') {
                sourceClass = 'warning';
                sourceColor = '#ffc107';
            } else if (source === 'IEA') {
                sourceClass = 'success';
                sourceColor = '#28a745';
            }
            
            html += `
                <div class="news-card international" style="border-left-color: ${sourceColor}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="news-date">
                                    <i class="far fa-calendar me-1"></i>${newsDate}
                                </span>
                                <span class="badge bg-${sourceClass} source-badge ms-2">
                                    <i class="fas fa-globe me-1"></i>${source}
                                </span>
                            </div>
                            <span class="news-source" style="color: ${sourceColor}">
                                <i class="fas fa-language me-1"></i>English
                            </span>
                        </div>
                        
                        <!-- 英文标题 -->
                        <h5 class="news-title mb-2" onclick="window.open('${newsLink}', '_blank')" style="cursor: pointer;">
                            ${news.title_original}
                        </h5>
                        
                        <!-- 中文翻译 -->
                        ${translateEnabled && hasTranslation ? `
                            <div class="translation-section mt-2 p-3 bg-light rounded">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-language text-success me-2"></i>
                                    <strong class="text-success">中文翻译</strong>
                                </div>
                                <h6 class="text-muted mb-2">${news.title_translated}</h6>
                                ${news.summary_translated ? `
                                    <p class="text-muted mb-0 small">${news.summary_translated}</p>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- 原文摘要 -->
                        ${newsSummary ? `
                            <div class="news-description mt-2">
                                <p class="text-muted mb-3">${newsSummary}</p>
                            </div>
                        ` : ''}
                        
                        <div class="mt-3 d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.open('${newsLink}', '_blank')">
                                <i class="fas fa-external-link-alt me-1"></i>查看原文
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // 更新翻译统计
        document.getElementById('translatedCount').textContent = translatedCount;
        
        newsList.innerHTML = html;
    }
    
    // 更新统计信息
    function updateStats(result) {
        document.getElementById('totalCount').textContent = result.total_count || 0;
        document.getElementById('filteredCount').textContent = result.count || 0;
        
        const sourceStats = result.source_stats || {};
        document.getElementById('pvMagazineCount').textContent = sourceStats['PV Magazine'] || 0;
        document.getElementById('irenaCount').textContent = sourceStats['IRENA'] || 0;
        document.getElementById('ieaCount').textContent = sourceStats['IEA'] || 0;
    }
    
    // 显示消息
    function showMessage(message, type) {
        // 移除现有消息
        const existingMsg = document.getElementById('updateMessage');
        if (existingMsg) {
            existingMsg.remove();
        }
        
        // 创建新消息
        const messageDiv = document.createElement('div');
        messageDiv.id = 'updateMessage';
        let alertClass = 'alert-info';
        if (type === 'error') alertClass = 'alert-danger';
        if (type === 'success') alertClass = 'alert-success';
        
        messageDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
        messageDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // 插入到筛选卡片后面
        const filterCard = document.querySelector('.filter-card');
        filterCard.parentNode.insertBefore(messageDiv, filterCard.nextSibling);
    }
    
    // 监听翻译开关变化
    document.getElementById('translateToggle').addEventListener('change', function() {
        loadNews();
    });
    
    // 监听输入框回车键
    document.getElementById('keyword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadNews();
        }
    });
    
    // 页面加载时设置默认日期并加载新闻
    document.addEventListener('DOMContentLoaded', function() {
        setDefaultDates();
        loadDataInfo();
        loadNews();
    });
</script>

<style>
.news-card.international {
    border-left: 4px solid #ff6b35;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.news-card.international:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.source-badge {
    font-size: 0.8rem;
}

.translation-section {
    border-left: 3px solid #28a745;
    background: linear-gradient(135deg, #f8fff9, #e8f5e8) !important;
}

.news-description {
    border-top: 1px solid #e9ecef;
    padding-top: 12px;
}

.news-card.international .news-title {
    color: #2c3e50;
    cursor: pointer;
    transition: color 0.2s;
    line-height: 1.4;
}

.news-card.international .news-title:hover {
    color: #007bff;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
}

.empty-state i {
    opacity: 0.7;
}

.loading {
    text-align: center;
    padding: 3rem 1rem;
    display: none;
}

.stats-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.stats-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
}

.stats-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.filter-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .translation-section {
        font-size: 0.9rem;
    }
    
    .stats-card {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stats-number {
        font-size: 1.5rem;
    }
    
    .filter-card .card-body {
        padding: 1.5rem;
    }
}
</style>
{% endblock %}