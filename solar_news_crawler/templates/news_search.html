{% extends "base.html" %}

{% block title %}光伏新闻搜索 - 双数据源{% endblock %}

{% block nav_extra %}
    <a class="btn btn-outline-primary" href="{{ url_for('index') }}">
        <i class="fas fa-home me-1"></i>返回主页
    </a>
{% endblock %}

{% block content %}
<!-- 头部区域 -->
<div class="header-section">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-3">光伏新闻搜索</h1>
        <p class="lead mb-4">按时间范围搜索国家能源局与中国政府网的光伏新闻</p>
    </div>
</div>

<div class="container">
    <!-- 数据信息区域 -->
    <div id="data-info" class="mb-3">
        <!-- 数据信息将在这里显示 -->
    </div>

    <!-- 筛选区域 -->
    <div class="filter-card">
        <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label fw-bold">开始日期</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">结束日期</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">数据来源</label>
                    <select class="form-select" id="sourceFilter">
                        <option value="">全部来源</option>
                        <option value="国家能源局">国家能源局</option>
                        <option value="中国政府网">中国政府网</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">关键词筛选</label>
                    <input type="text" class="form-control" id="keyword" placeholder="输入关键词...">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2" onclick="loadNews()">
                        <i class="fas fa-search me-2"></i>筛选新闻
                    </button>
                    <button class="btn btn-outline-primary w-100" id="refreshBtn" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="totalCount">0</div>
                <div class="stats-label">总新闻数</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="filteredCount">0</div>
                <div class="stats-label">筛选结果</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="neaCount">0</div>
                <div class="stats-label">国家能源局</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" id="govCount">0</div>
                <div class="stats-label">中国政府网</div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3">正在加载新闻数据...</p>
    </div>

    <!-- 新闻列表 -->
    <div id="newsList"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 设置默认日期（最近一个月）
    function setDefaultDates() {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 1);
        
        document.getElementById('startDate').valueAsDate = startDate;
        document.getElementById('endDate').valueAsDate = endDate;
    }
    
    // 加载数据统计信息
    async function loadDataInfo() {
        try {
            const response = await fetch('/get_stats');
            const data = await response.json();
            
            if (data.success) {
                const infoDiv = document.getElementById('data-info');
                let sourceStatsHtml = '';
                
                // 生成来源统计HTML
                for (const [source, count] of Object.entries(data.source_stats)) {
                    sourceStatsHtml += `<span class="badge bg-secondary me-2">${source}: ${count}</span>`;
                }
                
                infoDiv.innerHTML = `
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="fas fa-database me-1"></i>数据来源:</strong> JSON文件
                                <span class="ms-3"><strong>数据总量:</strong> ${data.total_count} 条</span>
                                <span class="ms-3"><strong>最后更新:</strong> ${data.last_update || '未知'}</span>
                            </div>
                            <div>
                                ${sourceStatsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('获取数据信息失败:', error);
            document.getElementById('data-info').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>无法获取数据统计信息
                </div>
            `;
        }
    }
    
    // 加载新闻数据
    async function loadNews() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const keyword = document.getElementById('keyword').value;
        const sourceFilter = document.getElementById('sourceFilter').value;
        
        // 显示加载动画
        document.getElementById('loading').style.display = 'block';
        document.getElementById('newsList').innerHTML = '';
        
        try {
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (keyword) params.append('keyword', keyword);
            if (sourceFilter) params.append('source', sourceFilter);
            
            const response = await fetch(`/get_news?${params}`);
            const result = await response.json();
            
            if (result.success) {
                displayNews(result.data);
                updateStats(result);
            } else {
                showUpdateMessage('加载失败: ' + result.error, 'error');
            }
        } catch (error) {
            showUpdateMessage('网络错误: ' + error.message, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }
    
    // 显示新闻列表
    function displayNews(newsData) {
        const newsList = document.getElementById('newsList');
        
        if (newsData.length === 0) {
            newsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">未找到相关新闻</h4>
                    <p class="text-muted">请尝试调整筛选条件或刷新数据</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        newsData.forEach((news, index) => {
            const sourceClass = news.source === '国家能源局' ? 'nea' : 'gov';
            const sourceTextClass = news.source === '国家能源局' ? 'source-nea' : 'source-gov';
            const badgeClass = news.source === '国家能源局' ? 'badge-nea' : 'badge-gov';
            
            html += `
                <div class="news-card ${sourceClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="news-date">
                                    <i class="far fa-calendar me-1"></i>${news.date}
                                </span>
                                <span class="badge ${badgeClass} source-badge ms-2">${news.source}</span>
                            </div>
                            <span class="news-source ${sourceTextClass}">
                                <i class="fas fa-database me-1"></i>${news.source}
                            </span>
                        </div>
                        <h5 class="news-title mb-3" onclick="window.open('${news.link}', '_blank')">
                            ${news.title}
                        </h5>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.open('${news.link}', '_blank')">
                                <i class="fas fa-external-link-alt me-1"></i>查看原文
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        newsList.innerHTML = html;
    }
    
    // 更新统计信息
    function updateStats(result) {
        document.getElementById('totalCount').textContent = result.total_count;
        document.getElementById('filteredCount').textContent = result.count;
        
        // 更新各来源数量
        const neaCount = result.filtered_source_stats['国家能源局'] || 0;
        const govCount = result.filtered_source_stats['中国政府网'] || 0;
        
        document.getElementById('neaCount').textContent = neaCount;
        document.getElementById('govCount').textContent = govCount;
    }
    
    // 刷新数据
    async function refreshData() {
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn.innerHTML;
        
        // 显示加载状态
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>更新中...';
        refreshBtn.disabled = true;
        
        try {
            const response = await fetch('/refresh_news');
            const result = await response.json();
            
            if (result.success) {
                // 显示更新提示
                showUpdateMessage('数据更新中，这可能需要几分钟时间，请稍候...', 'info');
                
                // 定期检查更新状态
                checkUpdateStatus();
            } else {
                showUpdateMessage('刷新失败: ' + result.error, 'error');
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        } catch (error) {
            showUpdateMessage('网络错误: ' + error.message, 'error');
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        }
    }
    
    // 检查更新状态
    async function checkUpdateStatus() {
        try {
            const response = await fetch('/check_update');
            const result = await response.json();
            
            if (result.success && result.updated) {
                // 更新完成，重新加载数据和统计信息
                showUpdateMessage(result.message, 'success');
                loadDataInfo(); // 重新加载数据统计信息
                loadNews(); // 重新加载新闻列表
                
                // 恢复按钮状态
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>刷新数据';
                refreshBtn.disabled = false;
            } else if (result.success && !result.updated) {
                // 还在更新中，继续检查
                setTimeout(checkUpdateStatus, 2000);
            } else {
                showUpdateMessage('更新失败: ' + result.message, 'error');
                
                // 恢复按钮状态
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>刷新数据';
                refreshBtn.disabled = false;
            }
        } catch (error) {
            console.error('检查更新状态失败:', error);
            setTimeout(checkUpdateStatus, 2000);
        }
    }
    
    // 显示更新消息
    function showUpdateMessage(message, type) {
        // 移除现有消息
        const existingMsg = document.getElementById('updateMessage');
        if (existingMsg) {
            existingMsg.remove();
        }
        
        // 创建新消息
        const messageDiv = document.createElement('div');
        messageDiv.id = 'updateMessage';
        let alertClass = 'alert-info';
        if (type === 'error') alertClass = 'alert-danger';
        if (type === 'success') alertClass = 'alert-success';
        
        messageDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
        messageDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // 插入到筛选卡片后面
        const filterCard = document.querySelector('.filter-card');
        filterCard.parentNode.insertBefore(messageDiv, filterCard.nextSibling);
    }
    
    // 页面加载时设置默认日期并加载新闻
    document.addEventListener('DOMContentLoaded', function() {
        setDefaultDates();
        loadDataInfo(); // 加载数据统计信息
        loadNews(); // 加载新闻数据
    });
</script>
{% endblock %}